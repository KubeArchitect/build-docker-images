---
version: 2.1

# define the parameters from the setup config.  
parameters:  
  megalinter:  
    type: boolean  
    default: false  
  build-fedora-image:  
    type: boolean  
    default: false

jobs:
  megalinter:
    docker:
      - image: oxsecurity/megalinter-cupcake:v8.3.0
        auth: 
           username: $DOCKER_HUB_USER
           password: $DOCKER_HUB_PASSWORD
    resource_class: large
    steps: 
      - checkout  
      - run:
          name: ml
          command: |
            export GITHUB_TOKEN=$GH_PACKAGES_TOKEN
            export CI_ACTION_RUN_URL=$CIRCLE_BUILD_URL
            export GITHUB_REPOSITORY=$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
            export GITHUB_REF=$CI_PULL_REQUEST
            export GITHUB_SHA=$CIRCLE_SHA1
            export DEFAULT_WORKSPACE=$CIRCLE_WORKING_DIRECTORY
            export GITHUB_WORKSPACE=$CIRCLE_WORKING_DIRECTORY
            export GITHUB_RUN_ID=$CIRCLE_BUILD_NUM
            /bin/bash -ex /entrypoint.sh
      - run:
          name: Get the updated sources in megalinter-reports
          command: |
            FILE_LIST=$(ls -A megalinter-reports/updated_sources/.* | grep -v 'megalinter-reports' | sed '/^[[:space:]]*$/d')
            if [ -n "$FILE_LIST" ]; then
              echo "Files have been updated"
              echo "$FILE_LIST"
              for file in $FILE_LIST; do
                cp -r megalinter-reports/updated_sources/$file .
              done
              echo "Files copied"
              ls -lA
            else
              echo "No files have been updated"
            fi
      - run:
          name: Set up Git bot
          command: |
            git config --local user.name "github-actions[bot]"
            git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
      - run:
          name: Commit changes
          command: |
            git add .
            git commit -m "Apply fixes"
            git push origin $CIRCLE_BRANCH
      - store_artifacts:
          path: megalinter-reports

workflows:
  megalinter-workflow:
    jobs:
      - megalinter